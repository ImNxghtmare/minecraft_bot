from rapidfuzz import fuzz

# ================================
#  ИНТЕНТЫ
# ================================
INTENT_RULES = "RULES"
INTENT_MEDIA = "MEDIA"
INTENT_TEAM = "TEAM"
INTENT_UNLINK = "UNLINK"
INTENT_TRANSFER_PRIV = "TRANSFER_PRIV"
INTENT_TRANSFER_BIND = "TRANSFER_BIND"
INTENT_PASSWORD_RESET = "PASSWORD_RESET"
INTENT_TOTP = "TOTP"
INTENT_REFUND = "REFUND"
INTENT_ITEM_TRANSFER = "ITEM_TRANSFER"
INTENT_PAYMENT_PROBLEM = "PAYMENT_PROBLEM"
INTENT_FORCE_BIND = "FORCE_BIND"
INTENT_AGENT_INFO = "AGENT_INFO"
INTENT_APPEAL = "APPEAL"
INTENT_WIPE = "WIPE"
INTENT_NEWS = "NEWS"
INTENT_IDIOTIC = "IDIOTIC"
INTENT_OPERATOR = "OPERATOR"
INTENT_HACKED = "HACKED"
INTENT_UNKNOWN = "UNKNOWN"


# ================================
#  ЖЁСТКИЙ ТОКС-ЛИСТ (до классификатора)
# ================================
TOXIC_WORDS = [
    "хуй", "хуи", "хуйн", "хуя", "ебан", "еблан", "нахуй",
    "пидор", "пидры", "пидоры", "уебан", "сука", "блять",
    "бля", "ебло", "гандон", "мразь", "какаш"
]


# ================================
#  ТРИГГЕРЫ
# ================================
TRIGGERS = {
    INTENT_RULES: [
        "правила", "правила сервера",
        "за что бан", "за шо бан", "почему бан", "почему мут",
        "че по правилам", "что можно что нельзя",
        "за что меня забанили", "какие у вас правила"
    ],

    INTENT_MEDIA: [
        "медиа", "в медиа", "как попасть в медиа", "набор в медиа",
        "хочу в медиа", "в медийку", "как стать медийным",
    ],

    INTENT_TEAM: [
        "в команду", "набор в команду", "как попасть в команду",
        "стать хелпером", "стать модером", "как к вам в тим",
    ],

    INTENT_UNLINK: [
        "отвязать акк", "отвязка", "убрать привязку", "снять привязку",
        "удалить привязку", "развязать аккаунт",
        "отвязать аккаунт", "отвязать мой акк",
    ],

    INTENT_TRANSFER_PRIV: [
        "перенос привы", "перекинуть приву", "перекинуть донат",
        "перенести привилегию", "передать приву",
    ],

    INTENT_TRANSFER_BIND: [
        "перенос привязки", "сменить привязку", "сменить вк",
        "перенести привязку", "смена привязки", "сменить номер"
    ],

    INTENT_PASSWORD_RESET: [
        "сброс пароля", "как восстановить пароль", "как поменять пароль",
        "не помню пароль", "забыл пароль", "сменить пароль",
    ],

    INTENT_TOTP: [
        "топт", "totp", "аутентификация", "как отключить топт",
        "двухфакторка", "2fa", "код из приложения", "не приходит код"
    ],

    INTENT_REFUND: [
        "возврат", "вернуть деньги", "хочу возврат",
        "отмена покупки", "возврат средств"
    ],

    INTENT_ITEM_TRANSFER: [
        "перенос товара", "перенести товар", "оплатил не на тот акк",
        "перекинуть товар", "перенести покупку на другой аккаунт"
    ],

    INTENT_PAYMENT_PROBLEM: [
        "не пришел донат", "не пришёл донат", "донат не пришел",
        "не пришел товар", "товар не пришел",
        "оплатил но не пришло", "не пришли кубики", "не пришли кейсы",
        "оплата не прошла", "списали деньги но доната нет",
        "нет покупки после оплаты", "оплата зависла",
    ],

    INTENT_FORCE_BIND: [
        "принудительная привязка", "акк привязался",
        "аккаунт привязан", "жестко привязали"
    ],

    INTENT_AGENT_INFO: [
        "кто такой агент", "кто такие агенты", "кто ты",
        "ты агент", "агент поддержки", "ты человек", "ты бот",
        "как работает поддержка"
    ],

    INTENT_APPEAL: [
        "обжаловать", "апелляция", "жалоба", "обжалование",
        "куда жаловаться", "кинуть жалобу"
    ],

    INTENT_WIPE: [
        "когда вайп", "когда вайб", "вайп скоро", "будет ли вайп"
    ],

    INTENT_NEWS: [
        "новости проекта", "важные новости", "апдейты",
        "где новости проекта", "где смотреть новости",
    ],

    INTENT_HACKED: [
        "взломали аккаунт", "аккаунт украли", "украли акк",
        "меня взломали", "акк угнали", "мой акк украли",
    ],

    INTENT_IDIOTIC: [
        "сервер говно", "все лагает", "говносервер",
        "че за хуйня", "вы дебилы",
    ],

    INTENT_OPERATOR: [
        "оператор", "позвать оператора", "зови оператора",
        "живой человек", "хочу живого человека",
        "позвать агента", "позови агента",
        "дай оператора", "дай агента",
        "хочу оператора", "дайте оператора"
    ],
}


# ================================
#  КЛАССИФИКАТОР
# ================================
def detect_intent(text: str) -> str:
    text = (text or "").lower().strip()
    if not text:
        return INTENT_UNKNOWN

    # ===== сначала проверяем жёсткую токсичность =====
    for bad in TOXIC_WORDS:
        if bad in text:
            return INTENT_IDIOTIC

    # ===== fuzzy-классификация =====
    best_intent = None
    best_score = 0

    for intent, words in TRIGGERS.items():
        for w in words:
            score = fuzz.partial_ratio(text, w)

            # избегаем совпадений коротких слов (например "новости" на "как дела")
            if len(w) <= 4 and len(text) > 10:
                score -= 20

            if score > best_score:
                best_score = score
                best_intent = intent

    # ===== порог =====
    if best_score < 72:
        return INTENT_UNKNOWN

    return best_intent
